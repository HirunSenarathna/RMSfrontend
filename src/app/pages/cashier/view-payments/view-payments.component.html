<div class="view-payments-container">
    <p-toolbar>
      <div class="p-toolbar-group-left">
        <p-button label="Back to POS" icon="pi pi-arrow-left" styleClass="mr-2" routerLink="/pos"></p-button>
        <span class="section-title">Payment Records</span>
      </div>
      <div class="p-toolbar-group-right">
        <p-button label="Refresh" icon="pi pi-refresh" (onClick)="refreshPayments()"></p-button>
      </div>
    </p-toolbar>
  
    <div class="payments-content">
      <div class="filter-controls">
        <p-calendar [(ngModel)]="fromDate" placeholder="From Date" [showIcon]="true"></p-calendar>
        <p-calendar [(ngModel)]="toDate" placeholder="To Date" [showIcon]="true"></p-calendar>
        <p-dropdown [options]="paymentMethodOptions" [(ngModel)]="selectedPaymentMethod" placeholder="Payment Method"></p-dropdown>
        <p-dropdown [options]="paymentStatusOptions" [(ngModel)]="selectedPaymentStatus" placeholder="Payment Status"></p-dropdown>
        <button pButton label="Filter" icon="pi pi-filter" (click)="applyFilters()"></button>
      </div>
      
      <div class="payment-summary-cards">
        <div class="summary-card">
          <div class="summary-title">Today's Total</div>
          <div class="summary-amount">Rs. {{todayTotal.toFixed(2)}}</div>
          <div class="summary-details">{{todayCount}} transactions</div>
        </div>
        
        <div class="summary-card">
          <div class="summary-title">Cash</div>
          <div class="summary-amount">Rs. {{todayCash.toFixed(2)}}</div>
          <div class="summary-details">{{todayCashCount}} transactions</div>
        </div>
        
        <div class="summary-card">
          <div class="summary-title">Card</div>
          <div class="summary-amount">Rs. {{todayCard.toFixed(2)}}</div>
          <div class="summary-details">{{todayCardCount}} transactions</div>
        </div>
        
        <div class="summary-card">
          <div class="summary-title">Online</div>
          <div class="summary-amount">Rs. {{todayOnline.toFixed(2)}}</div>
          <div class="summary-details">{{todayOnlineCount}} transactions</div>
        </div>
      </div>
      
      <p-table [value]="payments" styleClass="p-datatable-sm" [paginator]="true" [rows]="10">
        <ng-template pTemplate="header">
          <tr>
            <th>Payment ID</th>
            <th>Order #</th>
            <th>Amount</th>
            <th>Method</th>
            <th>Status</th>
            <th>Date & Time</th>
            <th>Cashier</th>
            <th>Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-payment>
          <tr>
            <td>{{payment.id}}</td>
            <td>{{payment.order_id}}</td>
            <td>Rs. {{payment.amount.toFixed(2)}}</td>
            <td>{{payment.payment_method}}</td>
            <td>
              <p-tag [value]="payment.payment_status" [severity]="getPaymentStatusSeverity(payment.payment_status)"></p-tag>
            </td>
            <td>{{payment.created_at | date:'short'}}</td>
            <td>{{payment.cashier_id ? getCashierName(payment.cashier_id) : 'Online'}}</td>
            <td>
              <button pButton icon="pi pi-eye" class="p-button-rounded p-button-info p-button-sm mr-2"
                     pTooltip="View Order" (click)="viewOrder(payment.order_id)"></button>
              <button *ngIf="payment.payment_status === 'COMPLETED'" pButton icon="pi pi-refresh" 
                     class="p-button-rounded p-button-warning p-button-sm"
                     pTooltip="Refund" (click)="processRefund(payment)"></button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
  
  <!-- Order Management Section -->
  <div class="pos-container" *ngIf="false"> <!-- This section is hidden in the payments view -->
    <div class="pos-content">
      <div class="current-order">
        <h3>Current Order</h3>
        
        <p-table [value]="currentOrder.items" styleClass="order-table">
          <ng-template pTemplate="header">
            <tr>
              <th>Item</th>
              <th>Variant</th>
              <th>Price</th>
              <th>Qty</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item let-i="rowIndex">
            <tr>
              <td>{{item.item_name}}</td>
              <td>
                <span *ngIf="item.size">{{item.size}}</span>
                <span *ngIf="item.variant"> - {{item.variant}}</span>
              </td>
              <td>Rs. {{item.unit_price.toFixed(2)}}</td>
              <td>
                <p-inputNumber [(ngModel)]="item.quantity" 
                              (onInput)="updateItemQuantity(i, item.quantity)"
                              [showButtons]="true" 
                              [min]="1" [max]="100" [size]="'small'">
                </p-inputNumber>
              </td>
              <td>Rs. {{item.subtotal.toFixed(2)}}</td>
              <td>
                <button pButton icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-sm"
                       (click)="removeItem(i)"></button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="footer">
            <tr>
              <td colspan="4" class="text-right">Total:</td>
              <td colspan="2" class="total-amount">Rs. {{currentOrder.total_amount.toFixed(2)}}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="empty-message">No items added to order</td>
            </tr>
          </ng-template>
        </p-table>
        
        <div class="order-actions">
          <p-button label="Cancel Order" icon="pi pi-times" styleClass="p-button-danger mr-2" 
                   [disabled]="currentOrder.items.length === 0"
                   (onClick)="cancelOrder()"></p-button>
          <p-button label="Process Payment" icon="pi pi-check" styleClass="p-button-success" 
                   [disabled]="currentOrder.items.length === 0"
                   (onClick)="openPaymentDialog()"></p-button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Payment Dialog -->
  <p-dialog header="Payment" [(visible)]="paymentDialog" [modal]="true" [style]="{width: '450px'}" 
            [closable]="false" [draggable]="false">
    <div class="payment-dialog">
      <div class="payment-total">
        <h3>Total Amount: Rs. {{currentOrder.total_amount.toFixed(2)}}</h3>
      </div>
      
      <div class="payment-method">
        <h4>Select Payment Method</h4>
        <div class="p-field-radiobutton">
          <p-radioButton name="paymentMethod" value="CASH" [(ngModel)]="paymentMethod" inputId="paymentCash"></p-radioButton>
          <label for="paymentCash" class="p-ml-2">Cash</label>
        </div>
        
        <div class="p-field-radiobutton">
          <p-radioButton name="paymentMethod" value="CARD" [(ngModel)]="paymentMethod" inputId="paymentCard"></p-radioButton>
          <label for="paymentCard" class="p-ml-2">Card</label>
        </div>
      </div>
      
      <div class="cash-payment" *ngIf="paymentMethod === 'CASH'">
        <div class="p-field">
          <label for="cashAmount">Cash Amount</label>
          <p-inputNumber id="cashAmount" [(ngModel)]="cashAmount" mode="currency" currency="LKR" 
                         (onInput)="calculateChange()" [min]="0" [minFractionDigits]="2">
          </p-inputNumber>
        </div>
        
        <div class="p-field change-amount">
          <label>Change</label>
          <div class="change-value" [class.negative]="changeAmount < 0">
            Rs. {{changeAmount.toFixed(2)}}
          </div>
        </div>
        
        <!-- Quick cash buttons -->
        <div class="quick-cash">
          <button pButton type="button" label="Rs. 500" class="p-button-outlined mr-2" 
                  (click)="cashAmount = 500; calculateChange()"></button>
          <button pButton type="button" label="Rs. 1000" class="p-button-outlined mr-2" 
                  (click)="cashAmount = 1000; calculateChange()"></button>
          <button pButton type="button" label="Rs. 5000" class="p-button-outlined" 
                  (click)="cashAmount = 5000; calculateChange()"></button>
        </div>
      </div>
      
      <div class="card-payment" *ngIf="paymentMethod === 'CARD'">
        <div class="p-field">
          <label>Amount to Charge</label>
          <div class="card-amount">Rs. {{currentOrder.total_amount.toFixed(2)}}</div>
        </div>
        
        <div class="card-notice">
          <p>Please swipe the card or use the card terminal to process payment.</p>
        </div>
      </div>
      
      <div class="payment-actions">
        <p-button label="Cancel" icon="pi pi-times" styleClass="p-button-text mr-2" 
                 (onClick)="paymentDialog = false"></p-button>
        <p-button label="Complete Payment" icon="pi pi-check" styleClass="p-button-success" 
                 [disabled]="paymentMethod === 'CASH' && changeAmount < 0"
                 (onClick)="processPayment()"></p-button>
      </div>
    </div>
  </p-dialog>