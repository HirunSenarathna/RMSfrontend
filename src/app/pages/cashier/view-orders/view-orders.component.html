<div class="view-orders-container">
    <p-toolbar>
      <div class="p-toolbar-group-left">
        <p-button label="Back to POS" icon="pi pi-arrow-left" styleClass="mr-2" routerLink="/pos"></p-button>
        <span class="section-title">View Orders</span>
      </div>
      <div class="p-toolbar-group-right">
        <p-button label="Refresh" icon="pi pi-refresh" (click)="loadOrders()"></p-button>
      </div>
    </p-toolbar>
  
    <div class="orders-content">
      <p-tabView>
        <p-tabPanel header="Today's Orders">
          <div class="filter-controls">
            <p-dropdown [options]="orderStatusOptions" placeholder="Filter by Status"></p-dropdown>
            <span class="p-input-icon-left">
              <i class="pi pi-search"></i>
              <input pInputText type="text" placeholder="Search orders" />
            </span>
          </div>
  
          <p-table [value]="todayOrders" [paginator]="true" [rows]="10" [responsive]="true" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
              <tr>
                <th>Order #</th>
                <th>Time</th>
                <th>Customer</th>
                <th>Total</th>
                <th>Status</th>
                <th>Payment</th>
                <th>Actions</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-order>
              <tr>
                <td>{{ order.order_number }}</td>
                <td>{{ order.created_at | date:'shortTime' }}</td>
                <td>{{ order.customer?.name || 'Guest' }}</td>
                <td>{{ order.total | currency }}</td>
                <td>
                  <p-tag [value]="order.status" [severity]="getStatusSeverity(order.status)"></p-tag>
                </td>
                <td>
                  <p-tag [value]="order.payment_status" [severity]="getPaymentStatusSeverity(order.payment_status)"></p-tag>
                </td>
                <td>
                  <p-button icon="pi pi-eye" styleClass="p-button-text" (click)="viewOrderDetails(order)" pTooltip="View Details"></p-button>
                  <p-button *ngIf="order.payment_status === 'PENDING'" icon="pi pi-dollar" styleClass="p-button-text p-button-success" (click)="processPaymentForOrder(order)" pTooltip="Process Payment"></p-button>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="7" class="text-center">No orders found for today</td>
              </tr>
            </ng-template>
          </p-table>
        </p-tabPanel>
  
        <p-tabPanel header="All Orders">
          <div class="filter-controls">
            <p-dropdown [options]="orderStatusOptions" placeholder="Filter by Status"></p-dropdown>
            <span class="p-input-icon-left">
              <i class="pi pi-search"></i>
              <input pInputText type="text" placeholder="Search orders" />
            </span>
          </div>
  
          <p-table [value]="allOrders" [paginator]="true" [rows]="10" [responsive]="true" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
              <tr>
                <th>Order #</th>
                <th>Date</th>
                <th>Customer</th>
                <th>Total</th>
                <th>Status</th>
                <th>Payment</th>
                <th>Actions</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-order>
              <tr>
                <td>{{ order.order_number }}</td>
                <td>{{ order.created_at | date:'short' }}</td>
                <td>{{ order.customer?.name || 'Guest' }}</td>
                <td>{{ order.total | currency }}</td>
                <td>
                  <p-tag [value]="order.status" [severity]="getStatusSeverity(order.status)"></p-tag>
                </td>
                <td>
                  <p-tag [value]="order.payment_status" [severity]="getPaymentStatusSeverity(order.payment_status)"></p-tag>
                </td>
                <td>
                  <p-button icon="pi pi-eye" styleClass="p-button-text" (click)="viewOrderDetails(order)" pTooltip="View Details"></p-button>
                  <p-button *ngIf="order.payment_status === 'PENDING'" icon="pi pi-dollar" styleClass="p-button-text p-button-success" (click)="processPaymentForOrder(order)" pTooltip="Process Payment"></p-button>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="7" class="text-center">No orders found</td>
              </tr>
            </ng-template>
          </p-table>
        </p-tabPanel>
      </p-tabView>
    </div>
  
    <!-- Order Details Dialog -->
    <p-dialog [(visible)]="orderDetailsVisible" [style]="{width: '50vw'}" header="Order Details" [modal]="true" [draggable]="false" [resizable]="false">
      <div *ngIf="selectedOrder" class="order-details">
        <div class="p-grid">
          <div class="p-col-12 p-md-6">
            <h3>Order #{{ selectedOrder.id }}</h3>
            <p><strong>Date:</strong> {{ selectedOrder.created_at | date:'medium' }}</p>
            <p><strong>Customer:</strong> {{ selectedOrder.customer_name || 'Guest' }}</p>
            <!-- <p><strong>Phone:</strong> {{ selectedOrder.customer?.phone || 'N/A' }}</p> -->
          </div>
          <div class="p-col-12 p-md-6">
            <div class="status-section">
              <!-- <div>
                <label for="orderStatus">Order Status:</label>
                <p-dropdown id="orderStatus" [options]="orderStatusOptions" [(ngModel)]="selectedOrder.status" [disabled]="selectedOrder.status === 'COMPLETED' || selectedOrder.status === 'CANCELLED'"></p-dropdown>
                <p-button label="Update Status" (click)="updateOrderStatus()" styleClass="p-button-sm mt-2" [disabled]="selectedOrder.status === 'COMPLETED' || selectedOrder.status === 'CANCELLED'"></p-button>
              </div> -->
              <div class="mt-3">
                <strong>Payment Status:</strong>
                <p-tag [value]="selectedOrder.payment_status" [severity]="getPaymentStatusSeverity(selectedOrder.payment_status)"></p-tag>
              </div>
            </div>
          </div>
        </div>
  
        <h3>Order Items</h3>
        <p-table [value]="selectedOrder.items" styleClass="p-datatable-sm">
          <ng-template pTemplate="header">
            <tr>
              <th>Item</th>
              <th>Options</th>
              <th class="text-right">Price</th>
              <th class="text-right">Qty</th>
              <th class="text-right">Total</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.product.name }}</td>
              <td>
                <span *ngFor="let option of item.options; let last = last">
                  {{ option.name }}: {{ option.value }}{{ !last ? ', ' : '' }}
                </span>
              </td>
              <td class="text-right">{{ item.unit_price | currency }}</td>
              <td class="text-right">{{ item.quantity }}</td>
              <td class="text-right">{{ item.quantity * item.unit_price | currency }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="footer">
            <tr>
              <td colspan="4" class="text-right"><strong>Subtotal:</strong></td>
              <td class="text-right">{{ selectedOrder.subtotal | currency }}</td>
            </tr>
            <tr *ngIf="selectedOrder.total_amount > 0">
              <td colspan="4" class="text-right"><strong>Tax:</strong></td>
              <td class="text-right">{{ selectedOrder.total_amount | currency }}</td>
            </tr>
            <!-- <tr *ngIf="selectedOrder.discount_amount > 0">
              <td colspan="4" class="text-right"><strong>Discount:</strong></td>
              <td class="text-right">-{{ selectedOrder.discount_amount | currency }}</td>
            </tr> -->
            <tr>
              <td colspan="4" class="text-right"><strong>Total:</strong></td>
              <td class="text-right">{{ selectedOrder.total | currency }}</td>
            </tr>
          </ng-template>
        </p-table>
  
        <!-- <div *ngIf="selectedOrder.notes" class="mt-3">
          <h3>Notes</h3>
          <p>{{ selectedOrder.notes }}</p>
        </div> -->
  
        <div class="mt-3 text-right">
          <p-button *ngIf="selectedOrder.payment_status === 'PENDING'" label="Process Payment" icon="pi pi-dollar" (click)="processPaymentForOrder(selectedOrder)" styleClass="p-button-success mr-2"></p-button>
          <p-button label="Print Receipt" icon="pi pi-print" styleClass="p-button-secondary"></p-button>
        </div>
      </div>
    </p-dialog>
  </div>